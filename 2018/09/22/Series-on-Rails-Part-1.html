<!DOCTYPE html>
<html>
  <head>
    <title>HTTParty, JSON requests and the right Content-Type</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    <link rel="apple-touch-icon" sizes="57x57" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-57x57.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="60x60" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-60x60.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="72x72" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-72x72.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="76x76" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-76x76.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="114x114" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-114x114.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="120x120" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-120x120.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="144x144" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-144x144.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="152x152" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-152x152.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="apple-touch-icon" sizes="180x180" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/apple-touch-icon-180x180.png?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="icon" type="image/png" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/favicon-32x32.png?v=wAAv6Wqe6l?v=1537650960817" sizes="32x32">
    <link rel="icon" type="image/png" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/favicon-194x194.png?v=wAAv6Wqe6l?v=1537650960817" sizes="194x194">
    <link rel="icon" type="image/png" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/favicon-96x96.png?v=wAAv6Wqe6l?v=1537650960817" sizes="96x96">
    <link rel="icon" type="image/png" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/android-chrome-192x192.png?v=wAAv6Wqe6l?v=1537650960817" sizes="192x192">
    <link rel="icon" type="image/png" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/favicon-16x16.png?v=wAAv6Wqe6l?v=1537650960817" sizes="16x16">
    <link rel="manifest" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/manifest.json?v=wAAv6Wqe6l?v=1537650960817">
    <link rel="shortcut icon" href="//TRex22.github.io/blog/themes/uno-zen/assets/img/favicon.ico?v=wAAv6Wqe6l?v=1537650960817">
    <meta name="msapplication-TileColor" content="#e74c3c">
    <meta name="msapplication-TileImage" content="//TRex22.github.io/blog/themes/uno-zen/assets/img/mstile-144x144.png?v=wAAv6Wqe6l?v=1537650960817">
    <meta name="msapplication-config" content="//TRex22.github.io/blog/themes/uno-zen/assets/img/browserconfig.xml?v=wAAv6Wqe6l?v=1537650960817">
    <meta name="theme-color" content="#e74c3c">
    <link rel="stylesheet" type="text/css" href="//TRex22.github.io/blog/themes/uno-zen/assets/css/uno-zen.css?v=1537650960817" />
    <link rel="canonical" href="https://TRex22.github.io/blog/2018/09/22/Series-on-Rails-Part-1.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Ramblings of a Dude" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="HTTParty, JSON requests and the right Content-Type" />
    <meta property="og:description" content="This post is about an issue I discovered whilst trying to debug an issue with a JSON request to a third party service. This request contained a JSON body where one of the fields was an array of strings but when querying the service to see what was sent -" />
    <meta property="og:url" content="https://TRex22.github.io/blog/2018/09/22/Series-on-Rails-Part-1.html" />
    <meta property="og:image" content="solusalt.jpg" />
    <meta property="article:published_time" content="2018-09-22T00:00:00.000Z" />
    <meta property="article:tag" content="Open_Source" />
    <meta property="article:tag" content="Ruby_On_Rails" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HTTParty, JSON requests and the right Content-Type" />
    <meta name="twitter:description" content="This post is about an issue I discovered whilst trying to debug an issue with a JSON request to a third party service. This request contained a JSON body where one of the fields was an array of strings but when querying the service to see what was sent -" />
    <meta name="twitter:url" content="https://TRex22.github.io/blog/2018/09/22/Series-on-Rails-Part-1.html" />
    <meta name="twitter:image:src" content="solusalt.jpg" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Ramblings of a Dude",
    "author": {
        "@type": "Person",
        "name": "Jason Chalom",
        "image": "https://avatars1.githubusercontent.com/u/2313094?v=4",
        "url": "https://TRex22.github.io/blog/author/TRex22/",
        "sameAs": "https://jasonchalom.com",
        "description": "I Build, I Make, I Code"
    },
    "headline": "HTTParty, JSON requests and the right Content-Type",
    "url": "https://TRex22.github.io/blog/2018/09/22/Series-on-Rails-Part-1.html",
    "datePublished": "2018-09-22T00:00:00.000Z",
    "image": "solusalt.jpg",
    "keywords": "Open_Source, Ruby_On_Rails",
    "description": "This post is about an issue I discovered whilst trying to debug an issue with a JSON request to a third party service. This request contained a JSON body where one of the fields was an array of strings but when querying the service to see what was sent -"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Ramblings of a Dude" href="https://TRex22.github.io/blog/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  </head>
  <body class="post-template tag-Open-Source tag-Ruby-On-Rails">
    <header id="menu-button" class="expanded">
      <a><i class="icon icon-list"></i></a>
    </header>
    <aside class="cover" style="background: url(/images/thearrangement.png) center/cover no-repeat fixed">
      <div class="cover container">
        <div class="profile">
          <a id="avatar-link" title="link to homepage for Ramblings of a Dude" href="https://TRex22.github.io/blog/#open">
            <img src="/logo.png" alt="Ramblings of a Dude avatar" class="profile avatar rounded hvr-buzz-out" />
            <h1 id="profile-title">Ramblings of a Dude</h1>
            <h3 id="profile-resume"></h3>
          </a>
    
          <hr class="divider long" />
          <p>Ramblings of a programmer, gamer, modder, maker and computer scientist</p>
          <hr class="divider short" />
          <div class="navigation">
            <div class="profile contact">
              <nav class="navigation left">
      <ul class="links">
          <li class="nav-homepage ">
            <a href="https://jasonchalom.com">homepage</a>
          </li>
      </ul>
    </nav>
    
              <nav class="navigation right">
                <ul class="social expanded">
              
              
                  <!-- Twitter -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://twitter.com/TRex2218" title="Twitter account">
                      <i class='icon icon-social-twitter'></i>
                      <span class="label">Twitter</span>
                    </a>
                  </li>
              
              
                  <!-- Github -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://github.com/TRex22" title="Github account">
                      <i class='icon icon-social-github'></i>
                      <span class="label">Github</span>
                    </a>
                  </li>
                  </li>
              
              
              
              
                  <!-- LinkedIn -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://www.linkedin.com/in/jasonchalom/" title="LinkedIn account">
                      <i class='icon icon-social-linkedin'></i>
                      <span class="label">LinkedIn</span>
                    </a>
                  </li>
              
                  <!-- Email -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="mailto:contact@jasonchalom.com" title="Email contact@jasonchalom.com">
                      <i class='icon icon-mail'></i>
                      <span class="label">Email</span>
                    </a>
                  </li>
              
                </ul>
              </nav>
              <!-- <section class="icon icon-search" id="search-container">
      <hr class="divider short" />
      <form id="search-form">
        <input type="text", name="search", placeholder="git, css, javascript,..." id="search-field" />
      </form>
    </section>
     -->
            </div>
          </div>
        </div>
      </div>
    </aside>
    <main>
      <section id="search-results"></section>
      <section class="content">
        

  <article class="post tag-Open-Source tag-Ruby-On-Rails">
    <header>
      <div class="post meta">
        <time datetime="22 Sep 2018">22 Sep 2018</time>
        <span class="post tags">in <a href="https://TRex22.github.io/blog/tag/Open-Source/">Open_Source</a> <a href="https://TRex22.github.io/blog/tag/Ruby-On-Rails/">Ruby_On_Rails</a></span>


        <span class="post reading-time"> ~ <span></span> read.</span>
      </div>
      <a alt="Tweet 'HTTParty, JSON requests and the right Content-Type'" href="https://twitter.com/intent/tweet?text=HTTParty%2C%20JSON%20requests%20and%20the%20right%20Content-Type%20%C2%BB&amp;hashtags=Open_Source,Ruby_On_Rails&amp;url=https://TRex22.github.io/blog/2018/09/22/Series-on-Rails-Part-1.html">
        <img id="post-image" src=solusalt.jpg alt="HTTParty, JSON requests and the right Content-Type">
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">HTTParty, JSON requests and the right Content-Type</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-Open-Source tag-Ruby-On-Rails">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post is about an issue I discovered whilst trying to debug an issue with a JSON request to a third party service. This request contained a JSON body where one of the fields was an array of strings but when querying the service to see what was sent - showed that the array was blank. The client used for this request makes use of HTTParty.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://TRex22.github.io/blog/images/solusalt.jpg" alt="solusalt">
</div>
</div>
<div class="paragraph">
<p>Initially I wanted to figure out what my client was sending through to the service. I attempted to use <code>binding.pry</code> and step through the client to see if something was not functioning correctly.</p>
</div>
<div class="paragraph">
<p>The body being sent through was something similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
  "Param1": "Param1",
  "Array": ["the", "and", "a"]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything seemed fine to me.</p>
</div>
<div class="paragraph">
<p>My next step was to backtrack and use Postman to check that the issue was the ruby client and not the third party.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The body was identical</p>
</li>
<li>
<p>Here the array was correctly sent to the service and correctly stored</p>
</li>
<li>
<p>The headers in the Postman request matched those set in the client</p>
</li>
</ol>
</div>
</div>
</div>
<h1 id="_an_example_of_the_response_i_get" class="sect0">An example of the response I get</h1>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
  "ID": 123,
  "Param1": "Param1",
  "Array": []
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another dead-end. So I decided to try and log the raw request the client was making. One of the tools used in this project is WebMock to mock out out clients and third party calls.</p>
</div>
<div class="paragraph">
<p>From <a href="https://tech.degica.com/en/2015/02/26/recording-http-examples/" class="bare">https://tech.degica.com/en/2015/02/26/recording-http-examples/</a> I added this callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>WebMock.after_request do |req, response|
  request = {
    uri: req.uri.to_s,
    method: req.method.to_s.upcase,
    headers: req.headers,
    body: req.body
  }
  puts JSON.pretty_generate(request)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allowed me to record what my client was actually doing.</p>
</div>
<h1 id="_the_raw_request" class="sect0">The raw request</h1>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
  :uri=&gt;"", :method=&gt;"PUT",
  :headers=&gt;{"X-Apikey"=&gt;"", "Accept"=&gt;"application/json"},
  :body=&gt;"Param1=Param1&amp;Array[]=the&amp;Array[]=and&amp;Array[]=a"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here what was most apparent is that the body seems to have been converted into a paramter string.</p>
</div>
<div class="paragraph">
<p><em>(A really good resource on HTTParty and parameter strings is: <a href="https://stackoverflow.com/questions/21856373/sending-array-variables-using-httparty" class="bare">https://stackoverflow.com/questions/21856373/sending-array-variables-using-httparty</a>)</em></p>
</div>
<div class="paragraph">
<p>I then wrote a quick and dirty HTTParty call - in the method I was debugging - to the same endpoint but with hardcoded values and a body hash, and it worked :)
I then did the exact same call but instead of the hardcoded values I used the same constructors as the previous code (the same header and body methods) and the exact same problem presented itself.</p>
</div>
<div class="paragraph">
<p>In my ensuing investigation I found that</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"Content-Type" =&gt; "application/json"</code></pre>
</div>
</div>
<div class="paragraph">
<p>was missing from the header parameters in the client. Even though the service does not need this header parameter, HTTParty does need it, otherwise it will default to converting the body into a paramter string when HTTParty is called (<code>.get</code>, <code>.post</code>, <code>.put</code> &#8230;&#8203;) and given a URI and options hash.</p>
</div>
<div class="paragraph">
<p>If HTTParty is called with the options directly added after the URI it works as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>HTTParty.put('https://google.com/', headers: {}, body: {})</code></pre>
</div>
</div>
<div class="paragraph">
<p>But if it is called with an options hash this other behaviour is observed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>options = {headers: {}, body: {}}
HTTParty.put('https://google.com/', options)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>format :json</code> after <code>include HTTParty</code> also may help.</p>
</div>
<h1 id="_the_correct_raw_request" class="sect0">The correct raw request</h1>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
  :uri=&gt;"", :method=&gt;"PUT",
  :headers=&gt;{"X-Apikey"=&gt;"", "Accept"=&gt;"application/json"},
  :body=&gt;{"Param1": "Param1", "Array": ["the", "and", "a"]}
}</code></pre>
</div>
</div>
<h1 id="_in_conclusion" class="sect0">In Conclusion</h1>
<div class="paragraph">
<p>I came across many people who seemed to be facing the same issue as myself but with no real solutions. The documentation did not seem to help and I found no mention of this behaviour.</p>
</div>
<div class="paragraph">
<p>By chance I was trying different configuration in desperation and came across the solution.</p>
</div>
    </div>

    <div class="post related">

    </div>

    <footer class="post comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'jasonchalomcom.disqus.com'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>

  </article>


        <footer>
          <span class="copyright">
            &copy; 2018. All rights reserved. Built with <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> under <a href="http://hubpress.io/" target="_blank">HubPress</a>.
          </span>
        </footer>
      </section>
    </main>

    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>
    <script src="//TRex22.github.io/blog/themes/uno-zen/assets/js/uno-zen.js?v=1537650960817" type="text/javascript" charset="utf-8"></script>
  </body>
</html>
